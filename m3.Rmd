---
title: "Milestone3"
output: html_document
---
```{r packages}
library(shiny)
library(tidyverse)
library(lubridate)
```

```{r clean}
## change file path
df = read.csv("./code/raw data/traffic_violaions.csv",
              na.strings=c("","NA"))
## no changes to the following code
df$search_type[is.na(df$search_type)] = "unknown" # add a new level unknown
# factor variables
df$driver_gender = as.factor(df$driver_gender)
df$driver_race = as.factor(df$driver_race)
df$violation_raw = as.factor(df$violation_raw)
df$violation = as.factor(df$violation)
df$search_type = as.factor(df$search_type)
df$stop_outcome = as.factor(df$stop_outcome)
df$stop_duration = as.factor(df$stop_duration)
df$stop_date = as.Date(mdy(df$stop_date)) # date variable
df = df[, -c(3, 5, 8)] #drop country_name, two raw variables
df = df %>% drop_na()
```

```{r helper methods}
## used in brushing to select the stop date
reset_selection <- function(x, brush) {
  brushedPoints(x, brush, allRows = TRUE)$selected_
}

## create the histogram using in brushing
## x axis is the stop date of the traffic violation
## the height of each bar represents the total number of violation at the stop date
## in m2, we planned to over the scatterplot, but it looks too messy so I changed to hist
hist_brushed <- function(df) {
  df %>%
    mutate(n = 1) %>%
    group_by(stop_date) %>%
    summarise(n = sum(n)) %>%
    ggplot(aes(stop_date, n)) +
    geom_col()
}

## create the frequency table for the search_type
table_search <- function(df){
  df %>%
    mutate(n = 1) %>%
    group_by(search_type) %>%
    summarise(n = sum(n))
}

```

```{r}
ui <- fluidPage(
  titlePanel("Hello Shiny!"), #change
  
  sidebarLayout(
    sidebarPanel(
      sliderInput("age", "Age", c(40,60), min = 15, max = 88, step = 1),
      checkboxGroupInput("gender", "Gender", choices = unique(df$driver_gender), 
                         selected = unique(df$driver_gender)), 
      # can only select one value ?change?
      selectInput("race", "Race", unique(df$driver_race)), 
      plotOutput("hist_brushed", brush = brushOpts("plot_brush", direction = "x"))),
    
    mainPanel(
      plotOutput("bar_vio"), #the number of different violation types
      plotOutput("bar_stop"), #stop outcomes
      plotOutput("bar_arr"), # a stacked bar plot: relationship between whether arrested and drug-related stops
      dataTableOutput("table_search"), #frequency table of search types
      dataTableOutput("table")) #the complete subset of the data
    )
  )


server <- function(input, output) {
  df_sub_brushed <- reactive({
    brushedPoints(df, input$plot_brush) %>%
      filter((driver_race %in% input$race),
             driver_gender %in% input$gender,
             driver_age >= input$age[1],
             driver_age <= input$age[2])
   })
  
  df_sub_unbrushed <- reactive({
    df %>%
      filter((driver_race %in% input$race),
             driver_gender %in% input$gender,
             driver_age >= input$age[1],
             driver_age <= input$age[2])
   })
  selected <- reactiveVal(rep(TRUE, nrow(df)))
  observeEvent(
    input$plot_brush,
    selected(reset_selection(df, input$plot_brush))
  )
  
  output$hist_brushed <- renderPlot(hist_brushed(df_sub_unbrushed()))
  output$table <- renderDataTable(df_sub_brushed())
  output$table_search = renderDataTable(table_search(df_sub_brushed()))
}

app <- shinyApp(ui, server)
app
```

